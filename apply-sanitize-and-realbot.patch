*** Begin Patch
*** Update File: twitter_auto_poster_V2.py
@@
-import requests
-import time
-from datetime import datetime
-import matplotlib.pyplot as plt
-import matplotlib.dates as mdates
-from matplotlib.patches import Rectangle
-import os
-
-# ==============================
-# TWITTER API CREDENTIALS
-# ==============================
-API_KEY = "qVRMpNK3qkshAG2TkHcSPAlQT"
-API_SECRET = "APfPjZAKRb2OhNGU5CLV4Cmd8qimATXdxc4EXMurPpBr2V"
-ACCESS_TOKEN = "2009041940382392320-DAxJ5L7toqWEqhtpBBZbN9iwxFWXdc"
-ACCESS_TOKEN_SECRET = "CN1lhdIl3TNGNmkNVr5XAHbE5UJE9IoKBrm9vlWrrDCHI"
-
-BRANDING_TEXT = "@tokennotifs"
+import requests
+import time
+from datetime import datetime
+import matplotlib.pyplot as plt
+import matplotlib.dates as mdates
+from matplotlib.patches import Rectangle
+import os
+import json
+
+# ==============================
+# TWITTER API CREDENTIALS (from environment variables)
+# ==============================
+API_KEY = os.getenv("TWITTER_API_KEY")
+API_SECRET = os.getenv("TWITTER_API_SECRET")
+ACCESS_TOKEN = os.getenv("TWITTER_ACCESS_TOKEN")
+ACCESS_TOKEN_SECRET = os.getenv("TWITTER_ACCESS_TOKEN_SECRET")
+
+BRANDING_TEXT = "@tokennotifs"
*** End Patch
*** Begin Patch
*** Add File: real_bot.py
+#!/usr/bin/env python3
+"""
+real_bot.py
+
+A safe posting module. Reads Twitter credentials from environment variables,
+uploads an optional image, posts a tweet using OAuth1 (requests-oauthlib),
+handles 429 (rate-limit) with retries/backoff, and returns a structured dict.
+"""
+import os
+import time
+import requests
+from typing import Dict, Any
+
+API_KEY = os.getenv("TWITTER_API_KEY")
+API_SECRET = os.getenv("TWITTER_API_SECRET")
+ACCESS_TOKEN = os.getenv("TWITTER_ACCESS_TOKEN")
+ACCESS_TOKEN_SECRET = os.getenv("TWITTER_ACCESS_TOKEN_SECRET")
+
+
+def _rate_headers(headers: Dict[str, str]) -> Dict[str, str]:
+    return {k: v for k, v in headers.items() if "rate" in k.lower() or k.lower() in ("retry-after", "x-rate-limit-reset")}
+
+
+def post_tweet(tweet_text: str, image_path: str = None, max_retries: int = 5, timeout: int = 30) -> Dict[str, Any]:
+    """
+    Post a tweet using OAuth1 (requests-oauthlib).
+    Returns a dict describing the result for logging by the wrapper.
+    """
+    from requests_oauthlib import OAuth1
+
+    if not all([API_KEY, API_SECRET, ACCESS_TOKEN, ACCESS_TOKEN_SECRET]):
+        return {"ok": False, "error": "Missing Twitter credentials in environment"}
+
+    auth = OAuth1(API_KEY, API_SECRET, ACCESS_TOKEN, ACCESS_TOKEN_SECRET)
+
+    # Optional image upload (v1.1 endpoint)
+    media_id = None
+    if image_path and os.path.exists(image_path):
+        upload_url = "https://upload.twitter.com/1.1/media/upload.json"
+        try:
+            with open(image_path, "rb") as f:
+                files = {"media": f}
+                r = requests.post(upload_url, auth=auth, files=files, timeout=timeout)
+            headers = dict(r.headers)
+            rate = _rate_headers(headers)
+            if r.status_code == 200:
+                media_id = r.json().get("media_id_string")
+            else:
+                return {"ok": False, "status_code": r.status_code, "text": r.text, "rate": rate}
+        except requests.RequestException as e:
+            return {"ok": False, "error": f"Image upload exception: {e}"}
+
+    url = "https://api.twitter.com/2/tweets"
+    payload: Dict[str, Any] = {"text": tweet_text}
+    if media_id:
+        payload["media"] = {"media_ids": [media_id]}
+
+    attempt = 0
+    while True:
+        attempt += 1
+        try:
+            r = requests.post(url, json=payload, auth=auth, timeout=timeout)
+            headers = dict(r.headers)
+            rate = _rate_headers(headers)
+
+            if r.status_code in (200, 201):
+                try:
+                    body = r.json()
+                except ValueError:
+                    body = {"text": r.text}
+                return {"ok": True, "status_code": r.status_code, "body": body, "rate": rate}
+
+            if r.status_code == 429:
+                # Rate limited
+                retry_after = headers.get("Retry-After")
+                reset_ts = headers.get("x-rate-limit-reset")
+                sleep = None
+                if retry_after:
+                    try:
+                        sleep = int(retry_after)
+                    except Exception:
+                        sleep = None
+                if sleep is None and reset_ts:
+                    try:
+                        sleep = max(0, int(reset_ts) - int(time.time()))
+                    except Exception:
+                        sleep = None
+                if sleep is None:
+                    sleep = min(60 * (2 ** (attempt - 1)), 3600)
+                if attempt >= max_retries:
+                    return {"ok": False, "status_code": 429, "text": r.text, "rate": rate}
+                time.sleep(sleep)
+                continue
+
+            # Non-retryable error
+            return {"ok": False, "status_code": r.status_code, "text": r.text, "rate": rate}
+
+        except requests.RequestException as e:
+            if attempt >= max_retries:
+                return {"ok": False, "error": f"RequestException: {e}"}
+            backoff = min(2 ** attempt, 60)
+            time.sleep(backoff)
+            continue
+
*** End Patch
*** Begin Patch
*** Add File: .github/workflows/main.yml
+name: Crypto Twitter Bot
+
+on:
+  schedule:
+    - cron: '0 * * * *'  # Every hour
+  workflow_dispatch:
+    inputs:
+      dry_run:
+        description: 'Set to "false" to allow posting (unsafe). Default true.'
+        required: false
+        default: 'true'
+
+jobs:
+  run-bot:
+    runs-on: ubuntu-latest
+    env:
+      DRY_RUN: ${{ github.event.inputs.dry_run }}
+
+    steps:
+    - uses: actions/checkout@v3
+
+    - name: Set up Python
+      uses: actions/setup-python@v4
+      with:
+        python-version: '3.12'
+
+    - name: Install dependencies
+      run: |
+        pip install -r requirements.txt || true
+
+    - name: Debug: show repo and bot.py
+      run: |
+        echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
+        pwd
+        echo "---- top-level repo listing ----"
+        ls -la
+        echo "---- .github listing ----"
+        ls -la .github || true
+        echo "---- bot.py (first 200 lines) ----"
+        sed -n '1,200p' bot.py || true
+
+    - name: Run bot
+      env:
+        TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
+        TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
+        TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
+        TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
+        DRY_RUN: ${{ env.DRY_RUN }}
+      run: python bot.py
+
+    - name: Upload bot logs and source
+      if: always()
+      uses: actions/upload-artifact@v3
+      with:
+        name: bot-logs
+        path: |
+          bot.log
+          bot.py
+
*** End Patch
